<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安橋保全_大巨蛋_八月份指定休假系統</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #fff5e6;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            text-align: center;
            background-color: #fff0d9;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: auto;
            max-height: 90vh;
        }
        h1, h2 {
            color: #8b4513;
            margin-bottom: 20px;
        }
        select, button, input {
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 16px;
        }
        button {
            cursor: pointer;
            background-color: #ffb347;
            color: #8b4513;
            border: none;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 3.2px #d97e00;
        }
        button:disabled {
            background-color: #d3d3d3;
            cursor: not-allowed;
            box-shadow: none;
        }
        button:hover {
            background-color: #ff9e21;
        }
        button:active {
            transform: translateY(3.2px);
            box-shadow: 0 1.6px #d97e00;
        }
        #calendar {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .day {
            padding: 49.5px 27px;
            background-color: #ffe4b5;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s;
        }
        .day:hover {
            background-color: #ffd27f;
        }
        .selected {
            background-color: #ffa07a !important;
        }
        .full {
            background-color: #d3d3d3;
            cursor: not-allowed;
        }
        .day-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-weight: bold;
            font-size: 1.5em;
            color: #8b4513;
        }
        .employee-list {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            background-color: #fff;
            border-radius: 5px;
            padding: 5px;
            font-size: 10px;
            color: #333;
            max-height: 60%;
            overflow-y: auto;
        }
        #selectedDates {
            margin-bottom: 20px;
            color: #8b4513;
        }
        #managerOptions {
            display: none;
            flex-direction: column;
        }
        #managerOptions button {
            margin-top: 10px;
        }
        .dialog {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            text-align: left;
            display: none;
        }
        .button-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>安橋保全_大巨蛋_八月份指定休假系統</h1>
        <div id="page1">
            <h2>選擇身份</h2>
            <select id="employeeSelect">
                <option value="">請選擇您的姓名</option>
                <option value="陳學正">陳學正</option>
                <option value="吳昆益">吳昆益</option>
                <option value="談正康">談正康</option>
                <option value="劉益誠">劉益誠</option>
                <option value="洪一倫">洪一倫</option>
                <option value="施增達">施增達</option>
                <option value="蔡銘南">蔡銘南</option>
                <option value="黃宇睿">黃宇睿</option>
                <option value="彭萬倉">彭萬倉</option>
                <option value="王淨月">王淨月</option>
                <option value="王瑞祥">王瑞祥</option>
                <option value="林祐弘">林祐弘</option>
                <option value="張維賢">張維賢</option>
                <option value="張能凱">張能凱</option>
                <option value="張宇賢">張宇賢</option>
                <option value="寇鴻儒">寇鴻儒</option>
                <option value="林峻源">林峻源</option>
                <option value="劉鐘泉">劉鐘泉</option>
                <option value="林雅君">林雅君</option>
                <option value="鐘保柱">鐘保柱</option>
                <option value="葉立臺">葉立臺</option>
            </select>
            <input type="password" id="passwordInput" placeholder="輸入密碼" style="display: none; margin: 0 auto;" inputmode="numeric">
            <button id="confirmIdentity">確認</button>
        </div>
        <div id="page2" style="display:none;">
            <h2>選擇休假日期</h2>
            <div id="calendar"></div>
            <div id="selectedDates"></div>
            <div class="button-group">
                <button id="backToIdentity">重新選擇身份</button>
                <button id="submitDates" disabled>送出</button>
                <button id="managerList" style="width: auto;" disabled>管理者功能</button>
            </div>
            <div id="managerOptions">
                <div id="managerActions" style="display: none;">
                    <button id="clearAllData">清除員工指休資料</button>
                    <button id="showStatistics">統計</button>
                    <button id="limit2">限休2人</button>
                    <button id="limit3">限休3人</button>
                    <button id="limit4">限休4人</button>
                    <button id="limit5">限休5人</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyC41oZEylj4tzNUR9boZlaeAzyzxnt4NZU",
            authDomain: "rock-idiom-408312.firebaseapp.com",
            projectId: "rock-idiom-408312",
            storageBucket: "rock-idiom-408312.appspot.com",
            messagingSenderId: "405862843184",
            appId: "1:405862843184:web:ef25b5c535f6cb94da7ef5",
            databaseURL: "https://rock-idiom-408312-default-rtdb.firebaseio.com/"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const realTimeDB = firebase.database();

        document.addEventListener('DOMContentLoaded', function() {
            const employeeSelect = document.getElementById('employeeSelect');
            const confirmIdentityButton = document.getElementById('confirmIdentity');
            const backToIdentityButton = document.getElementById('backToIdentity');
            const submitDatesButton = document.getElementById('submitDates');
            const page1 = document.getElementById('page1');
            const page2 = document.getElementById('page2');
            const calendar = document.getElementById('calendar');
            const selectedDatesDiv = document.getElementById('selectedDates');
            const passwordInput = document.getElementById('passwordInput');
            const managerOptions = document.getElementById('managerOptions');
            const managerListButton = document.getElementById('managerList');
            const managerActions = document.getElementById('managerActions');
            const clearAllDataButton = document.getElementById('clearAllData');
            const showStatisticsButton = document.getElementById('showStatistics');
            const limit2Button = document.getElementById('limit2');
            const limit3Button = document.getElementById('limit3');
            const limit4Button = document.getElementById('limit4');
            const limit5Button = document.getElementById('limit5');

            let selectedEmployee = '';
            let selectedDates = [];
            let employeesPerDay = {};
            let maxEmployeesPerDay = 4;
            const maxDaysEmployee = 3;
            const maxDaysManager = 10;
            const managers = ['陳學正', '吳昆益'];
            const managerPassword = '6233';
            let isManager = false;

            // 初始化日曆
            function renderCalendar() {
                for (let i = 1; i <= 31; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('day');

                    const dayNumber = document.createElement('div');
                    dayNumber.classList.add('day-number');
                    dayNumber.innerText = i;
                    dayDiv.appendChild(dayNumber);

                    const employeeList = document.createElement('div');
                    employeeList.classList.add('employee-list');
                    dayDiv.appendChild(employeeList);

                    dayDiv.addEventListener('click', () => selectDate(i));
                    calendar.appendChild(dayDiv);
                }
                // 設置實時數據監聽
                realTimeDB.ref('vacations').on('value', (snapshot) => {
                    employeesPerDay = snapshot.val() || {};
                    updateCalendar();
                });
            }

            // 選擇日期
            function selectDate(day) {
                const maxDays = isManager ? maxDaysManager : maxDaysEmployee;
                if (selectedDates.includes(day)) {
                    selectedDates = selectedDates.filter(d => d !== day);
                } else {
                    if (selectedDates.length >= maxDays) {
                        alert(`每月指定休假日以${maxDays}日為限。`);
                        return;
                    }
                    if (employeesPerDay[day] && employeesPerDay[day].length >= maxEmployeesPerDay) {
                        alert(`${day}已達休假人數上限`);
                        return;
                    }
                    selectedDates.push(day);
                }
                updateCalendar();
                updateSelectedDates();
                toggleSubmitButton();
            }

            // 更新日曆顯示
            function updateCalendar() {
                const days = calendar.querySelectorAll('.day');
                days.forEach(dayDiv => {
                    const day = parseInt(dayDiv.querySelector('.day-number').innerText);
                    dayDiv.classList.remove('selected', 'full');
                    const employeeList = dayDiv.querySelector('.employee-list');
                    employeeList.innerHTML = '';
                    if (selectedDates.includes(day)) {
                        dayDiv.classList.add('selected');
                    }
                    if (employeesPerDay[day]) {
                        employeesPerDay[day].forEach(employee => {
                            const employeeName = document.createElement('div');
                            employeeName.innerText = employee;
                            employeeList.appendChild(employeeName);
                        });
                        if (employeesPerDay[day].length >= maxEmployeesPerDay) {
                            dayDiv.classList.add('full');
                        }
                    }
                });
            }

            // 更新已選擇日期顯示
            function updateSelectedDates() {
                selectedDatesDiv.innerHTML = '已選日期: ' + selectedDates.join(', ');
            }

            // 切換送出按鈕狀態
            function toggleSubmitButton() {
                submitDatesButton.disabled = selectedDates.length < 1;
            }

            // 清除舊日期
            function clearOldDates() {
                for (const day in employeesPerDay) {
                    employeesPerDay[day] = employeesPerDay[day].filter(employee => employee !== selectedEmployee);
                }
            }

            // 確認身份
            confirmIdentityButton.addEventListener('click', () => {
                selectedEmployee = employeeSelect.value;
                if (!selectedEmployee) {
                    alert('請選擇您的姓名。');
                    return;
                }
                if (managers.includes(selectedEmployee)) {
                    passwordInput.style.display = 'block';
                    passwordInput.focus();
                    if (!passwordInput.value) {
                        alert('請輸入密碼。');
                        return;
                    }
                    if (passwordInput.value !== managerPassword) {
                        alert('密碼錯誤。');
                        return;
                    }
                    isManager = true;
                } else {
                    isManager = false;
                }
                if (!confirm(`您選擇的身份是 ${selectedEmployee}，是否確認？`)) {
                    return;
                }
                passwordInput.style.display = 'none';
                passwordInput.value = '';
                page1.style.display = 'none';
                page2.style.display = 'block';
                managerOptions.style.display = isManager ? 'flex' : 'none';
                managerListButton.disabled = !isManager;
                fetchVacationData();
            });

            // 返回身份選擇頁面
            backToIdentityButton.addEventListener('click', () => {
                if (!confirm('是否重新選擇身份？此操作將不保留目前選擇的日期。')) {
                    return;
                }
                selectedDates = [];
                updateCalendar();
                updateSelectedDates();
                toggleSubmitButton();
                page2.style.display = 'none';
                page1.style.display = 'block';
            });

            // 送出休假日期
            submitDatesButton.addEventListener('click', () => {
                if (!confirm(`你選擇的日期為 ${selectedDates.join(', ')}，是否確定？`)) {
                    return;
                }
                saveVacationData();
            });

            // 管理者功能顯示
            managerListButton.addEventListener('click', () => {
                managerActions.style.display = managerActions.style.display === 'none' ? 'block' : 'none';
            });

            // 清除所有員工的休假記錄
            clearAllDataButton.addEventListener('click', () => {
                if (confirm('是否確認清除本月份全體員工的指休紀錄？')) {
                    db.collection('vacations').get().then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            doc.ref.delete();
                        });
                        realTimeDB.ref('vacations').set({});
                        alert('全體員工的指休紀錄已清除。');
                        employeesPerDay = {};
                        updateCalendar();
                    });
                }
            });

            // 顯示統計
            showStatisticsButton.addEventListener('click', () => {
                const statistics = {};
                db.collection('vacations').get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!statistics[data.employee]) {
                            statistics[data.employee] = [];
                        }
                        statistics[data.employee] = statistics[data.employee].concat(data.dates);
                    });
                    let statsString = '';
                    for (const employee in statistics) {
                        statsString += `${employee}: ${statistics[employee].join(', ')}\n`;
                    }
                    alert(statsString.trim());
                });
            });

            limit2Button.addEventListener('click', () => setLimit(2));
            limit3Button.addEventListener('click', () => setLimit(3));
            limit4Button.addEventListener('click', () => setLimit(4));
            limit5Button.addEventListener('click', () => setLimit(5));

            function setLimit(limit) {
                if (confirm(`此操作將清除所有員工休假紀錄，是否確定將每日休假人數限制為${limit}人？`)) {
                    db.collection('vacations').get().then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            doc.ref.delete();
                        });
                        realTimeDB.ref('vacations').set({});
                        maxEmployeesPerDay = limit;
                        alert(`每日休假人數已限制為${limit}人`);
                        employeesPerDay = {};
                        updateCalendar();
                    });
                }
            }

            function fetchVacationData() {
                db.collection('vacations').get().then((querySnapshot) => {
                    employeesPerDay = {};
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        data.dates.forEach(date => {
                            if (!employeesPerDay[date]) {
                                employeesPerDay[date] = [];
                            }
                            employeesPerDay[date].push(data.employee);
                        });
                    });
                    updateCalendar();
                });
            }

            function saveVacationData() {
                // 清除舊日期
                clearOldDates();

                // 更新新日期
                selectedDates.forEach(day => {
                    if (!employeesPerDay[day]) {
                        employeesPerDay[day] = [];
                    }
                    employeesPerDay[day].push(selectedEmployee);
                });

                // 刪除Firestore中的舊數據
                db.collection('vacations')
                    .where('employee', '==', selectedEmployee)
                    .get()
                    .then((querySnapshot) => {
                        const batch = db.batch();
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        return batch.commit();
                    })
                    .then(() => {
                        // 保存新的數據到Firestore
                        const data = {
                            employee: selectedEmployee,
                            dates: selectedDates
                        };
                        return db.collection('vacations').add(data);
                    })
                    .then(() => {
                        // 更新Realtime Database
                        realTimeDB.ref('vacations').set(employeesPerDay);

                        // 檢查選擇的日期是否達到上限
                        selectedDates.forEach(day => {
                            if (employeesPerDay[day].length >= maxEmployeesPerDay) {
                                realTimeDB.ref('vacations').child(day).once('value', (snapshot) => {
                                    const employees = snapshot.val();
                                    if (employees && employees.length >= maxEmployeesPerDay) {
                                        // 通知其他員工並取消他們選擇的日期
                                        realTimeDB.ref('selections').once('value', (snapshot) => {
                                            const selections = snapshot.val();
                                            for (const employee in selections) {
                                                if (selections[employee].includes(day)) {
                                                    selections[employee] = selections[employee].filter(d => d !== day);
                                                    alert(`${day}已達休假人數上限，請重新選擇日期。`);
                                                }
                                            }
                                            realTimeDB.ref('selections').set(selections);
                                        });
                                    }
                                });
                            }
                        });

                        alert('指定休假已更新完成。');
                        selectedDates = [];
                        fetchVacationData();
                        updateSelectedDates();
                        toggleSubmitButton();
                        page2.style.display = 'none';
                        page1.style.display = 'block';
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        alert('Failed to register vacation dates.');
                    });
            }

            renderCalendar();
        });
    </script>
</body>
</html>